name: Build Windows Wheel

on:
  workflow_dispatch:

jobs:
  build_windows_wheel:
    name: Build wheel for Windows on Python 3.11
    runs-on: windows-latest

    steps:
      # 1. Скачиваем код вашего форка
      - uses: actions/checkout@v4

      # 2. Устанавливаем Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Устанавливаем Rust
      - uses: dtolnay/rust-toolchain@stable

      # 4. Клонируем репозиторий TensorFlow
      - name: Clone TensorFlow repository
        run: git clone https://github.com/tensorflow/tensorflow.git

      # 5. Устанавливаем CMake
      - name: Install CMake
        shell: pwsh
        run: |
          $cmake_url = "https://github.com/Kitware/CMake/releases/download/v3.26.0/cmake-3.26.0-windows-x64.zip"
          Invoke-WebRequest -Uri $cmake_url -OutFile cmake.zip
          Expand-Archive -Path cmake.zip -DestinationPath cmake
          $env:CMAKE_PATH = "$PWD\cmake\bin"
          $env:Path += ";$PWD\cmake\bin"

      # 6. Собираем TensorFlow Lite C++
      - name: Build TensorFlow Lite C++
        shell: pwsh
        run: |
          cd tensorflow
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE=Release -DTENSORFLOW_LITE_BUILD=ON ..
          cmake --build . --config Release

      # 7. Копируем библиотеку TensorFlow Lite C++
      - name: Copy TensorFlow Lite C++ library
        shell: pwsh
        run: |
          Copy-Item -Path "tensorflow/build/Release/tensorflowlite.dll" -Destination "tflite_lib/tensorflowlite_c.dll"
          Copy-Item -Path "tensorflow/build/Release/tensorflowlite.lib" -Destination "tflite_lib/tensorflowlite_c.lib"

      # 8. Собираем "колесо"
      - name: Build wheel
        shell: bash
        run: |
          pip install maturin
          maturin build --release --out dist --find-interpreter

      # 9. Загружаем результат
      - uses: actions/upload-artifact@v4
        with:
          name: dtln-rs-wheel-windows-py311
          path: dist
